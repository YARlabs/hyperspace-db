syntax = "proto3";
package hyperspace;

service Database {
  // Insert vectors
  rpc Insert (InsertRequest) returns (InsertResponse);
  // Delete vectors
  rpc Delete (DeleteRequest) returns (DeleteResponse);
  // Search (ANN)
  rpc Search (SearchRequest) returns (SearchResponse);
  // Stream statistics for TUI
  rpc Monitor (MonitorRequest) returns (stream SystemStats);
  
  // Admin Controls
  rpc TriggerSnapshot (Empty) returns (StatusResponse);
  rpc TriggerVacuum (Empty) returns (StatusResponse);
  
  // Dynamic Configuration
  rpc Configure (ConfigUpdate) returns (StatusResponse);
  
  // Replication (Leader -> Follower)
  rpc Replicate (Empty) returns (stream ReplicationLog);
}

message ReplicationLog {
  uint32 id = 1;
  repeated double vector = 2;
  map<string, string> metadata = 3;
}

enum QuantizationMode {
  NONE = 0;       // f64 (Default)
  SCALAR_I8 = 1;  // 8-bit
}

message ConfigUpdate {
  optional uint32 ef_search = 1;
  optional uint32 ef_construction = 2;
}

message InsertRequest {
  repeated double vector = 1;
  uint32 id = 2; // Explicit ID for simplicity in this proto
  map<string, string> metadata = 3;
}

message InsertResponse {
  bool success = 1;
}

message DeleteRequest {
  uint32 id = 1;
}

message DeleteResponse {
  bool success = 1;
}

message SearchRequest {
  repeated double vector = 1; // Query vector
  uint32 top_k = 2;           // How many neighbors to find
  map<string, string> filter = 3; // Metadata filter (legacy, equality)
  repeated Filter filters = 4;    // Advanced filters
}

message Filter {
  oneof condition {
    Match match = 1;
    Range range = 2;
  }
}

message Match {
  string key = 1;
  string value = 2;
}

message Range {
  string key = 1;
  optional int64 gte = 2;
  optional int64 lte = 3;
}

message SearchResponse {
  repeated SearchResult results = 1;
}

message SearchResult {
  uint32 id = 1;
  double distance = 2;
}

message Empty {}

message StatusResponse {
  string status = 1;
}

message MonitorRequest {}

message SystemStats {
  uint64 indexed_vectors = 1;
  uint64 soft_deleted = 2;
  
  // Storage Metrics
  double raw_data_size_mb = 3;      // Size if f64
  double actual_storage_mb = 4;     // Size on disk
  double compression_ratio = 5;     // Ratio
  uint32 active_segments = 6;       // Count
  
  // Performance
  double qps = 7;
  double ram_usage_mb = 8;
  
  // Current Config (for TUI display)
  uint32 ef_search = 9;
  uint32 ef_construction = 10;
  uint64 index_queue_size = 11;     // Pending indexing tasks
}
