# === HYPERSPACE DB CONFIGURATION ===

# --- Server Dimensions & Metric ---
# Use 'poincare', 'l2', 'cosine' and 'lorentz' as metric
HS_DIMENSION=1024
HS_METRIC=cosine

# Option 2: Scientific / Native Hyperbolic
# Use 'poincare' for maximum efficiency on compressed hyperbolic vectors.
# HS_DIMENSION=64
# HS_METRIC=poincare

# --- HNSW Engine Tuning ---
# --- Metrics #1 ---
# Database        | Dim   | Metric   | Ins QPS  | Srch QPS | P99 Lat    | Recall(Sys) | MRR   | NDCG  | C1     | C10    | C30    |
# --------------------------------------------------------------------------------------------------------------------------------
# Hyperspace      | 1024  | Cosine   |    24542 |     1036 |    1.73 ms |       89.8% |  1.00 |  0.92 |   1205 |   2931 |   2753 |
# Hyperspace      | 64    | Poincare |   157950 |     2912 |    0.88 ms |       99.8% |  1.00 |  0.92 |   4893 |   2784 |   2326 |
# HS_HNSW_M=48
# HS_HNSW_EF_CONSTRUCT=200
# HS_HNSW_EF_SEARCH=200

# --- HNSW Engine Tuning ---
# --- Metrics #2 ---
# Database        | Dim   | Metric   | Ins QPS  | Srch QPS | P99 Lat    | Recall(Sys) | MRR   | NDCG  | C1     | C10    | C30    |
# --------------------------------------------------------------------------------------------------------------------------------
# Hyperspace      | 1024  | Cosine   |    23662 |      995 |    2.36 ms |       99.8% |  1.00 |  0.92 |   1146 |   2761 |   2473 |
# Hyperspace      | 64    | Poincare |   158675 |     2777 |    1.52 ms |       99.9% |  1.00 |  0.92 |   4577 |   2725 |   2401 |
HS_HNSW_M=64
HS_HNSW_EF_CONSTRUCT=400
HS_HNSW_EF_SEARCH=400
# If filtered candidate set is small, bypass HNSW layer-0 traversal and run exact brute-force over allowed bitmap.
HS_FILTER_BRUTEFORCE_THRESHOLD=50000

# --- Durability & Safety ---
# Options: async (default), batch (100ms lag), strict (fsync every write)
# Controls the trade-off between write speed and data safety.
HYPERSPACE_WAL_SYNC_MODE=batch
# Interval for Batch mode in milliseconds
HYPERSPACE_WAL_BATCH_INTERVAL=100

# --- Indexing Performance ---
# Number of parallel threads for HNSW graph construction
# 1 = Serial (best quality/recall, slower indexing)
# 0 = Auto (uses all CPU cores, faster but lower recall due to race conditions)
# Recommended: 1 for production, 0 for bulk imports where recall can be sacrificed
HS_INDEXER_CONCURRENCY=8

# --- Storage & Quantization ---
# Options: none, scalar (i8), binary (1 bit)
# Note: Scalar quantization clamps values to [-1, 1]. Use 'none' for unbounded L2 vectors if you care about magnitude > 1.
HS_QUANTIZATION_LEVEL=scalar
# Store raw (mode=none) vectors as f32 in mmap, then promote to f64 in distance kernel. Saves ~50% RAM for raw vectors.
HS_STORAGE_FLOAT32=true
# Fast-upsert threshold: if vector shift L2 <= delta and metadata unchanged, skip graph relinking.
# 0.0 disables fast-upsert (always relink graph).
# Typical values: 0.001..0.05 for small continuous updates; >0.1 may preserve stale neighborhood links.
HS_FAST_UPSERT_DELTA=0.0
# Broadcast ring size for CDC/replication event stream.
HS_EVENT_STREAM_BUFFER=1024
# Enable exact top-K re-rank after ANN candidate fetch.
HS_RERANK_ENABLED=true
# Oversample factor for ANN candidates before exact re-rank.
HS_RERANK_OVERSAMPLE=8
# Enable runtime auto-dispatch policy for batch metric kernels.
HS_GPU_BATCH_ENABLED=false
# Conservative offload thresholds to avoid GPU regression on tiny rerank batches.
HS_GPU_MIN_BATCH=192
HS_GPU_MIN_DIM=1024
HS_GPU_MIN_WORK=393216
# Per-metric GPU dispatch toggles (effective only when HS_GPU_BATCH_ENABLED=true and build uses --features gpu-runtime).
HS_GPU_L2_ENABLED=true
HS_GPU_COSINE_ENABLED=true
HS_GPU_POINCARE_ENABLED=true
HS_GPU_LORENTZ_ENABLED=true
# Internal fan-out for SearchBatch handler (1 = deterministic/serial, >1 = bounded parallel).
HS_SEARCH_BATCH_INNER_CONCURRENCY=32
# Global limit for concurrent search tasks in collection worker pool.
# 0 = auto (CPU count), recommended range: CPU..(CPU*4) depending on latency SLA.
HS_SEARCH_CONCURRENCY=32

# --- Graph Optimization (Compaction) ---
# Automatic graph rebuild interval in hours (0 = disabled)
# Rebuilds the HNSW graph sequentially for maximum quality
# Recommended: 24-48 hours for production systems with high write load
# Set to 0 to disable automatic optimization
HS_OPTIMIZE_INTERVAL_HOURS=0


# --- Security ---
HYPERSPACE_API_KEY=I_LOVE_HYPERSPACEDB

# === EMBEDDING PIPELINE CONFIGURATION ===
# Provide vectors automatically (InsertText).
HYPERSPACE_EMBED=False

# Provider: 'local' (ONNX), 'openai', 'cohere', 'mistral', 'voyage', 'gemini', 'openrouter'
HYPERSPACE_EMBED_PROVIDER=local

# --- Local ONNX Model (Provider=local) ---
# Path to .onnx file
# HYPERSPACE_MODEL_PATH=./models/v5_Embedding_128d.onnx
# HYPERSPACE_TOKENIZER_PATH=./models/v5_Embedding_Tokenizer.json
# HYPERSPACE_EMBED_DIM=128

# --- Remote API (Provider=openai/cohere/etc) ---
# HYPERSPACE_API_KEY=PLACEHOLDER_FOR_K8S_SECRET
# HYPERSPACE_EMBED_MODEL=text-embedding-3-small
# HYPERSPACE_API_BASE=... (Optional base URL override)

# --- System Tuning ---
# Jemalloc configuration for memory usage vs CPU trade-off.
# background_thread:true enables background memory reclamation.
# dirty_decay_ms:0 releases unused memory immediately (low RAM, higher CPU).
# dirty_decay_ms:10000 (default) keeps memory for reuse (high RAM, lower CPU).
MALLOC_CONF=background_thread:true,dirty_decay_ms:5000,muzzy_decay_ms:5000
